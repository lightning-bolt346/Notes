<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notes ‚Äî Personal</title>
  <meta name="description" content="Personal notes app ‚Äî offline-first with optional cloud sync" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230a84ff'/%3E%3Cpath d='M26 28h48v44a8 8 0 0 1-8 8H34a8 8 0 0 1-8-8V28z' fill='white'/%3E%3Cpath d='M34 20h32a8 8 0 0 1 8 8H26a8 8 0 0 1 8-8z' fill='white' opacity='.8'/%3E%3C/svg%3E"/>
  <style>
    :root {
      --bg: #0f1419;
      --panel: #1a1f29;
      --panel-2: #242936;
      --panel-hover: #2d3340;
      --border: #353c4a;
      --border-light: #404854;
      --text: #e6eefc;
      --text-secondary: #b0bcd0;
      --muted: #8a94a6;
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
      --accent-light: rgba(14, 165, 233, 0.15);
      --danger: #ef4444;
      --danger-light: rgba(239, 68, 68, 0.15);
      --warn: #f59e0b;
      --ok: #10b981;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 20px rgba(0,0,0,0.25);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.35);
      --blur: blur(12px);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="light"] {
      --bg: #fafbfc;
      --panel: #ffffff;
      --panel-2: #f8fafc;
      --panel-hover: #f1f5f9;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
      --text: #1e293b;
      --text-secondary: #475569;
      --muted: #64748b;
      --accent: #0ea5e9;
      --accent-2: #0284c7;
      --accent-light: rgba(14, 165, 233, 0.1);
      --danger: #dc2626;
      --danger-light: rgba(220, 38, 38, 0.1);
      --warn: #d97706;
      --ok: #059669;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app {
      display: grid;
      grid-template-columns: var(--sidebar-width, 250px) 1fr;
      grid-template-rows: 60px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
      height: 100vh;
      transition: var(--transition);
    }

    .app.sidebar-hidden {
      grid-template-columns: 0 1fr;
    }

    /* Header */
    header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: var(--blur);
      position: relative;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .brand .icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }

    .sync-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--muted);
      margin-left: 12px;
    }

    .sync-status.synced { color: var(--ok); border-color: var(--ok); background: rgba(16, 185, 129, 0.1); }
    .sync-status.syncing { color: var(--accent); border-color: var(--accent); background: var(--accent-light); }
    .sync-status.error { color: var(--danger); border-color: var(--danger); background: var(--danger-light); }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Sidebar */
    .sidebar {
      grid-area: sidebar;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      overflow: hidden;
      width: var(--sidebar-width, 250px);
    }

    .app.sidebar-hidden .sidebar {
      width: 0;
      border-right: none;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .search-container {
      position: relative;
      margin-bottom: 12px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 12px;
    }

    .sidebar-actions {
      display: flex;
      gap: 6px;
    }

    .filter-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
    }

    .filter-tag {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      background: var(--panel-2);
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .filter-tag.active, .filter-tag:hover {
      background: var(--accent-light);
      color: var(--accent);
      border-color: var(--accent);
    }

    /* Note List */
    .note-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .folder-item {
      margin: 2px 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
      background: var(--panel-2);
      border-left: 3px solid var(--accent);
    }

    .folder-item:hover {
      background: var(--panel-hover);
    }

    .folder-item.expanded {
      background: var(--accent-light);
    }

    .folder-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 12px;
      color: var(--text);
    }

    .folder-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 3px;
      transition: var(--transition);
    }

    .folder-notes {
      margin-top: 4px;
      border-left: 1px solid var(--border);
      margin-left: 8px;
      padding-left: 8px;
    }

    .note-item {
      margin: 2px 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
      position: relative;
    }

    .note-item:hover {
      background: var(--panel-hover);
      border-color: var(--border-light);
    }

    .note-item.active {
      background: var(--accent-light);
      border-color: var(--accent);
    }

    .note-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 4px;
      bottom: 4px;
      width: 2px;
      background: var(--accent);
      border-radius: 0 1px 1px 0;
    }

    .note-title {
      font-weight: 500;
      font-size: 13px;
      color: var(--text);
      line-height: 1.3;
      margin-bottom: 2px;
    }

    .note-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
    }

    .note-dates {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    /* Main Content */
    .main {
      grid-area: main;
      display: flex;
      flex-direction: column;
      background: var(--panel-2);
      min-height: 0;
    }

    .editor-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .title-input {
      flex: 1;
      font-size: 20px;
      font-weight: 600;
      background: transparent;
      border: none;
      color: var(--text);
      outline: none;
      padding: 6px 0;
    }

    .title-input::placeholder {
      color: var(--muted);
    }

    .editor-status {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: var(--muted);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--ok);
    }

    .status-dot.unsaved {
      background: var(--warn);
    }

    /* Toolbar */
    .editor-toolbar {
      padding: 8px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      gap: 4px;
      align-items: center;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .editor-toolbar::-webkit-scrollbar {
      display: none;
    }

    .toolbar-group {
      display: flex;
      gap: 4px;
      padding-right: 8px;
      margin-right: 8px;
      border-right: 1px solid var(--border);
    }

    .toolbar-group:last-child {
      border-right: none;
      margin-right: 0;
      padding-right: 0;
    }

    /* Editor Container */
    .editor-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr var(--md-divider-width, 1px) var(--md-editor-width, 0fr);
      min-height: 0;
      transition: var(--transition);
    }

    .editor-container.md-hidden {
      grid-template-columns: 1fr;
    }

    .editor-pane {
      min-height: 0;
      overflow: auto;
      background: var(--panel);
    }

    .editor-pane.hidden {
      display: none;
    }

    /* Resizer */
    .md-resizer {
      background: var(--border);
      cursor: col-resize;
      position: relative;
      transition: var(--transition);
    }

    .md-resizer:hover, .md-resizer.resizing {
      background: var(--accent);
    }

    .md-resizer::before {
      content: '';
      position: absolute;
      left: -2px;
      right: -2px;
      top: 0;
      bottom: 0;
    }

    /* WYSIWYG Editor */
    .wysiwyg-editor {
      padding: 24px;
      min-height: 100%;
      outline: none;
      line-height: 1.7;
      font-size: 15px;
    }

    .wysiwyg-editor h1, .wysiwyg-editor h2, .wysiwyg-editor h3 {
      margin: 2em 0 0.5em;
      line-height: 1.3;
    }

    .wysiwyg-editor h1:first-child,
    .wysiwyg-editor h2:first-child,
    .wysiwyg-editor h3:first-child {
      margin-top: 0;
    }

    .wysiwyg-editor p {
      margin: 1em 0;
    }

    .wysiwyg-editor ul, .wysiwyg-editor ol {
      margin: 1em 0;
      padding-left: 2em;
    }

    .wysiwyg-editor blockquote {
      margin: 1.5em 0;
      padding: 0 1.5em;
      border-left: 3px solid var(--accent);
      color: var(--text-secondary);
    }

    .wysiwyg-editor code {
      background: var(--panel-2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.9em;
    }

    /* Custom checkbox styling */
    .wysiwyg-editor input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    /* Markdown Editor */
    .markdown-pane {
      display: flex;
      flex-direction: column;
      background: var(--panel-2);
    }

    .markdown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .markdown-editor {
      flex: 1;
      padding: 24px;
      background: var(--panel-2);
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      text-decoration: none;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--panel-hover);
      border-color: var(--border-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: var(--accent);
      color: white;
    }

    .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn.danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    .btn.ghost {
      background: transparent;
      border-color: transparent;
    }

    .btn.small {
      padding: 4px 8px;
      font-size: 11px;
    }

    .btn.icon {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 6px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Status Bar */
    .status-bar {
      padding: 8px 20px;
      border-top: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
    }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: var(--blur);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.2s ease;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      max-width: 600px;
      width: 90vw;
      max-height: 80vh;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-content {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .form-field {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 10px 14px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    /* Login Screen */
    .login-screen {
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(1200px 800px at 80% -20%, rgba(14, 165, 233, 0.15), transparent),
        radial-gradient(1000px 700px at -10% 120%, rgba(16, 185, 129, 0.1), transparent),
        var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      text-align: center;
    }

    .login-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Utilities */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; }
    .gap-4 { gap: 16px; }
    .text-sm { font-size: 12px; }
    .font-medium { font-weight: 500; }
    .text-muted { color: var(--muted); }

    /* Responsive Design */
    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: 60px auto 1fr;
        grid-template-areas: 
          "header"
          "sidebar" 
          "main";
      }

      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 300px;
        width: auto !important;
      }

      .app.sidebar-hidden {
        grid-template-rows: 60px 0 1fr;
      }

      .app.sidebar-hidden .sidebar {
        height: 0;
        border-bottom: none;
      }

      .editor-container {
        grid-template-columns: 1fr;
      }

      .markdown-pane {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <div class="login-brand">
        <div class="icon">üìù</div>
        <h1 style="margin: 0; font-size: 28px; font-weight: 700;">Personal Notes</h1>
      </div>
      <div class="login-form">
        <input id="passwordInput" type="password" placeholder="Enter password" class="form-input" style="text-align: center;" />
        <button id="loginBtn" class="btn primary">Enter App</button>
        <div id="loginError" style="color: var(--danger); font-size: 13px; margin-top: 8px;"></div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="app hidden" data-theme="dark">
    <!-- Header -->
    <header>
      <div class="brand">
        <button id="toggleSidebarBtn" class="btn icon ghost">‚ò∞</button>
        <div class="icon">üìù</div>
        <div>Personal Notes</div>
        <div id="syncStatus" class="sync-status">offline</div>
      </div>
      <div class="header-actions">
        <button id="newNoteBtn" class="btn primary small">+ New Note</button>
        <button id="deleteNoteBtn" class="btn danger small">Delete</button>
        <button id="settingsBtn" class="btn ghost small">‚öôÔ∏è</button>
        <button id="themeToggleBtn" class="btn ghost small">üåô</button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="search-container">
          <div class="search-icon">üîç</div>
          <input id="searchInput" class="search-input" placeholder="Search notes..." />
        </div>
        <div class="sidebar-actions">
          <button id="newNoteBtn2" class="btn primary small">New Note</button>
          <button id="newFolderBtn" class="btn ghost small">üìÅ</button>
        </div>
      </div>
      
      <div class="filter-tags">
        <div class="filter-tag active" data-filter="all">All</div>
        <div class="filter-tag" data-filter="folders">üìÅ Folders</div>
        <div class="filter-tag" data-filter="pinned">üìå Pinned</div>
        <div class="filter-tag" data-filter="today">üìÖ Today</div>
      </div>

      <div id="noteList" class="note-list"></div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Editor Header -->
      <div class="editor-header">
        <input id="titleInput" class="title-input" placeholder="Untitled Note" />
        <div class="editor-status">
          <div class="status-indicator">
            <div id="saveStatusDot" class="status-dot"></div>
            <span id="saveStatusText">Saved</span>
          </div>
          <span id="lastModified">Just now</span>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="editor-toolbar">
        <div class="toolbar-group">
          <button class="btn icon" data-cmd="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
          <button class="btn icon" data-cmd="italic" title="Italic (Ctrl+I)"><em>I</em></button>
          <button class="btn icon" data-cmd="underline" title="Underline (Ctrl+U)"><u>U</u></button>
          <button class="btn icon" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
        </div>
        
        <div class="toolbar-group">
          <button class="btn icon" data-cmd="insertUnorderedList" title="Bullet List">‚Ä¢</button>
          <button class="btn icon" data-cmd="insertOrderedList" title="Numbered List">1.</button>
          <button id="checkboxBtn" class="btn icon" title="Checkbox">‚òê</button>
        </div>
        
        <div class="toolbar-group">
          <button class="btn icon" data-cmd="formatBlock" data-value="h1" title="Heading 1">H1</button>
          <button class="btn icon" data-cmd="formatBlock" data-value="h2" title="Heading 2">H2</button>
          <button class="btn icon" data-cmd="formatBlock" data-value="h3" title="Heading 3">H3</button>
          <button class="btn icon" data-cmd="formatBlock" data-value="p" title="Paragraph">P</button>
        </div>
        
        <div class="toolbar-group">
          <button id="colorBtn" class="btn icon" title="Text Color">üé®</button>
          <input type="color" id="colorPicker" class="hidden" />
          <button id="linkBtn" class="btn icon" title="Insert Link">üîó</button>
          <button id="codeBtn" class="btn icon" title="Code">&lt;/&gt;</button>
          <button id="quoteBtn" class="btn icon" title="Quote">‚ùù</button>
        </div>
        
        <div class="toolbar-group">
          <button id="toggleMdBtn" class="btn small">Show MD</button>
          <button id="focusModeBtn" class="btn small">Focus Mode</button>
          <button id="pinNoteBtn" class="btn small">üìå Pin</button>
        </div>
      </div>

      <!-- Editor Container -->
      <div id="editorContainer" class="editor-container md-hidden">
        <!-- WYSIWYG Pane -->
        <div id="wysiwygPane" class="editor-pane">
          <div id="wysiwygEditor" class="wysiwyg-editor" contenteditable="true"></div>
        </div>
        
        <!-- Resizer -->
        <div id="mdResizer" class="md-resizer"></div>
        
        <!-- Markdown Pane -->
        <div id="markdownPane" class="editor-pane markdown-pane">
          <div class="markdown-header">
            <span>Markdown Editor</span>
            <button id="hideMdBtn" class="btn ghost small">‚úï</button>
          </div>
          <textarea id="markdownEditor" class="markdown-editor" placeholder="Start writing in Markdown..."></textarea>
        </div>
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="flex items-center gap-4">
          <span id="noteCount">0 notes</span>
          <span>‚Ä¢</span>
          <span id="wordCount">0 words</span>
          <span>‚Ä¢</span>
          <span id="cursorPosition">Line 1, Col 1</span>
        </div>
        <div id="tagsDisplay" class="text-muted"></div>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 style="margin: 0;">Settings</h3>
        <button id="closeSettingsBtn" class="btn ghost small">‚úï</button>
      </div>
      <div class="modal-content">
        <div class="form-field">
          <label class="form-label">Appearance</label>
          <div class="flex gap-2">
            <button id="darkThemeBtn" class="btn small">üåô Dark</button>
            <button id="lightThemeBtn" class="btn small">‚òÄÔ∏è Light</button>
            <button id="autoThemeBtn" class="btn small">üîÑ Auto</button>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Cloud Sync</label>
          <div class="flex items-center gap-2" style="margin-bottom: 12px;">
            <input type="checkbox" id="enableSyncCheck" />
            <label for="enableSyncCheck">Enable GitHub Gist sync</label>
          </div>
          <input id="githubTokenInput" class="form-input" placeholder="GitHub Personal Access Token" style="margin-bottom: 8px;" />
          <input id="gistIdInput" class="form-input" placeholder="Gist ID (optional - will create new)" />
          <p style="font-size: 12px; color: var(--muted); margin: 8px 0 0;">
            Your token is stored locally and used only for syncing your notes to a private GitHub Gist.
          </p>
        </div>

        <div class="form-field">
          <label class="form-label">Export & Import</label>
          <div class="flex gap-2">
            <button id="exportBtn" class="btn small">üì• Export ZIP</button>
            <button id="importBtn" class="btn small">üì§ Import ZIP</button>
            <input id="importFileInput" type="file" accept=".zip" class="hidden" />
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Security</label>
          <div class="flex gap-2">
            <input id="newPasswordInput" type="password" class="form-input" placeholder="New password" />
            <button id="changePasswordBtn" class="btn small">Update</button>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Data Management</label>
          <div class="flex gap-2">
            <button id="clearSyncDataBtn" class="btn small danger">Clear Sync Data</button>
            <button id="resetAppBtn" class="btn small danger">Reset App</button>
          </div>
          <p style="font-size: 12px; color: var(--muted); margin: 8px 0 0;">
            Clear sync data to fix sync errors. Reset app to start fresh.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Folder Modal -->
  <div id="folderModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 style="margin: 0;">Select Folder</h3>
        <button id="closeFolderModalBtn" class="btn ghost small">‚úï</button>
      </div>
      <div class="modal-content">
        <div class="form-field">
          <label class="form-label">Move note to folder:</label>
          <select id="folderSelect" class="form-select">
            <option value="">No folder (Root)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button id="moveTolderBtn" class="btn primary small">Move</button>
          <button id="cancelFolderBtn" class="btn ghost small">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.3/dist/turndown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // Main Application
    class NotesApp {
      constructor() {
        this.PASSWORD_DEFAULT = "notes@123";
        this.state = {
          notes: new Map(),
          folders: new Map(),
          activeNoteId: null,
          settings: {
            theme: localStorage.getItem('notes-theme') || 'dark',
            sidebarWidth: parseInt(localStorage.getItem('notes-sidebar-width')) || 250,
            mdEditorWidth: parseInt(localStorage.getItem('notes-md-width')) || 300,
            mdEditorVisible: localStorage.getItem('notes-md-visible') === 'true',
            autoSave: true,
            syncEnabled: false,
            githubToken: localStorage.getItem('notes-github-token') || '',
            gistId: localStorage.getItem('notes-gist-id') || ''
          },
          ui: {
            sidebarVisible: true,
            focusMode: false,
            searchQuery: '',
            activeFilter: 'all',
            expandedFolders: new Set()
          }
        };

        this.debounceTimeouts = new Map();
        this.isResizing = false;
        this.turndown = new TurndownService({ 
          headingStyle: 'atx',
          codeBlockStyle: 'fenced'
        });
        
        this.init();
      }

      // Initialization
      async init() {
        await this.loadEnv();
        if (this.env && this.env.APP_PASSWORD) {
          this.PASSWORD_DEFAULT = this.env.APP_PASSWORD;
        }
        await this.initializePasswordGate();
        this.loadData();
        this.setupEventListeners();
        this.setupResizer();
        this.applyTheme();
        this.render();
        this.startAutoSave();
        
        // Load first note if available
        const noteIds = Array.from(this.state.notes.keys());
        if (noteIds.length > 0) {
          this.loadNote(noteIds[0]);
        }
      }

      // Password Protection
      async initializePasswordGate() {
        return new Promise((resolve) => {
          const storedHash = localStorage.getItem('notes-password-hash');
          if (!storedHash) {
            this.hashPassword(this.PASSWORD_DEFAULT).then(hash => {
              localStorage.setItem('notes-password-hash', hash);
              this.showLoginScreen(resolve);
            });
          } else {
            this.showLoginScreen(resolve);
          }
        });
      }

      showLoginScreen(callback) {
        const loginScreen = document.getElementById('loginScreen');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        const login = async () => {
          const password = passwordInput.value;
          const hash = await this.hashPassword(password);
          const storedHash = localStorage.getItem('notes-password-hash');

          if (hash === storedHash) {
            // Skip sync requirement - allow offline usage
            loginScreen.classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Try to sync in background if configured
            if (this.state.settings.syncEnabled && this.state.settings.githubToken) {
              this.updateSyncStatus('syncing');
              this.syncFromGist().then(success => {
                this.updateSyncStatus(success ? 'synced' : 'error');
              });
            }
            
            callback();
          } else {
            loginError.textContent = 'Incorrect password';
            passwordInput.value = '';
            passwordInput.focus();
          }
        };

        passwordInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') login();
        });
        loginBtn.addEventListener('click', login);
        passwordInput.focus();
      }

      async hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      // Data Management
      loadData() {
        const stored = localStorage.getItem('notes-data');
        if (stored) {
          try {
            const data = JSON.parse(stored);
            this.state.notes = new Map(data.notes?.map(note => [note.id, note]) || []);
            this.state.folders = new Map(data.folders?.map(folder => [folder.id, folder]) || []);
          } catch (e) {
            console.error('Failed to load notes:', e);
          }
        }
      }

      saveData() {
        try {
          const data = {
            notes: Array.from(this.state.notes.values()),
            folders: Array.from(this.state.folders.values()),
            version: 3,
            savedAt: new Date().toISOString()
          };
          localStorage.setItem('notes-data', JSON.stringify(data));
          this.updateSaveStatus('saved');
          
          // Background sync if enabled
          if (this.state.settings.syncEnabled && this.state.settings.githubToken) {
            this.updateSyncStatus('syncing');
            this.syncToGist().then(success => {
              this.updateSyncStatus(success ? 'synced' : 'error');
            });
          }
        } catch (error) {
          console.error('Save failed:', error);
          this.updateSaveStatus('error');
        }
      }

      // Note Operations
      createNote(title = 'Untitled', folderId = null) {
        const id = this.generateId();
        const now = new Date().toISOString();
        const note = {
          id,
          title,
          content: '',
          markdown: '',
          tags: [],
          pinned: false,
          folderId: folderId,
          createdAt: now,
          updatedAt: now
        };

        this.state.notes.set(id, note);
        this.saveData();
        this.render();
        this.loadNote(id);
        return note;
      }

      createFolder(name) {
        const id = this.generateId();
        const folder = {
          id,
          name: name || 'New Folder',
          createdAt: new Date().toISOString()
        };
        
        this.state.folders.set(id, folder);
        this.state.ui.expandedFolders.add(id);
        this.saveData();
        this.render();
        return folder;
      }

      deleteNote(id) {
        if (!id || !confirm('Delete this note? This action cannot be undone.')) return;
        
        this.state.notes.delete(id);
        
        if (this.state.activeNoteId === id) {
          this.state.activeNoteId = null;
          this.clearEditor();
        }
        
        this.saveData();
        this.render();
      }

      deleteFolder(id) {
        if (!id || !confirm('Delete this folder and all its notes? This action cannot be undone.')) return;
        
        // Delete all notes in the folder
        for (const [noteId, note] of this.state.notes) {
          if (note.folderId === id) {
            this.state.notes.delete(noteId);
          }
        }
        
        this.state.folders.delete(id);
        this.state.ui.expandedFolders.delete(id);
        
        if (this.state.activeNoteId && !this.state.notes.has(this.state.activeNoteId)) {
          this.state.activeNoteId = null;
          this.clearEditor();
        }
        
        this.saveData();
        this.render();
      }

      loadNote(id) {
        const note = this.state.notes.get(id);
        if (!note) return;

        this.state.activeNoteId = id;
        
        document.getElementById('titleInput').value = note.title || '';
        document.getElementById('markdownEditor').value = note.markdown || '';
        
        // Safely set HTML content and strip any problematic elements
        const cleanContent = this.sanitizeHtmlContent(note.content || '');
        document.getElementById('wysiwygEditor').innerHTML = cleanContent;
        
        this.updateWordCount();
        this.updateTags();
        this.render();
      }

      // Sanitize HTML content to prevent issues with images and other problematic elements
      sanitizeHtmlContent(html) {
        // Create a temporary div to parse HTML
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Remove all images to prevent sync issues
        const images = temp.querySelectorAll('img');
        images.forEach(img => {
          const placeholder = document.createElement('span');
          placeholder.textContent = '[Image removed]';
          placeholder.style.color = 'var(--muted)';
          placeholder.style.fontStyle = 'italic';
          img.parentNode.replaceChild(placeholder, img);
        });
        
        // Remove other problematic elements
        const problematic = temp.querySelectorAll('script, object, embed, iframe, video, audio');
        problematic.forEach(el => el.remove());
        
        return temp.innerHTML;
      }

      updateNote(updates) {
        if (!this.state.activeNoteId) return;
        
        const note = this.state.notes.get(this.state.activeNoteId);
        if (!note) return;

        Object.assign(note, updates, { updatedAt: new Date().toISOString() });
        this.state.notes.set(this.state.activeNoteId, note);
        
        this.updateSaveStatus('saving');
        this.debounceSave();
        this.updateTags();
        this.render();
      }

      moveNoteToFolder(noteId, folderId) {
        const note = this.state.notes.get(noteId);
        if (!note) return;
        
        note.folderId = folderId || null;
        this.updateNote(note);
      }

      // Editor Operations
      clearEditor() {
        document.getElementById('titleInput').value = '';
        document.getElementById('markdownEditor').value = '';
        document.getElementById('wysiwygEditor').innerHTML = '';
        this.updateWordCount();
        this.updateTags();
      }

      syncEditors(source) {
        if (source === 'wysiwyg') {
          const html = document.getElementById('wysiwygEditor').innerHTML;
          const markdown = this.turndown.turndown(html);
          document.getElementById('markdownEditor').value = markdown;
          this.updateNote({ content: html, markdown });
        } else if (source === 'markdown') {
          const markdown = document.getElementById('markdownEditor').value;
          const html = marked.parse(markdown);
          const cleanHtml = this.sanitizeHtmlContent(html);
          document.getElementById('wysiwygEditor').innerHTML = cleanHtml;
          this.updateNote({ content: cleanHtml, markdown });
        }
        this.updateWordCount();
      }

      // Toolbar Commands
      execCommand(command, value = null) {
        const editor = document.getElementById('wysiwygEditor');
        editor.focus();
        try { document.execCommand('styleWithCSS', false, true); } catch (e) {}
        document.execCommand(command, false, value);
        this.syncEditors('wysiwyg');
      }

      insertCheckbox() {
        const editor = document.getElementById('wysiwygEditor');
        editor.focus();
        const checkbox = '<input type="checkbox" /> ';
        document.execCommand('insertHTML', false, checkbox);
        this.syncEditors('wysiwyg');
      }

      // UI Updates
      render() {
        this.renderNoteList();
        this.updateCounts();
      }

      renderNoteList() {
        const noteList = document.getElementById('noteList');
        
        // Get folders and notes
        const folders = Array.from(this.state.folders.values());
        const notes = Array.from(this.state.notes.values());
        
        // Filter based on search and active filter
        let filteredNotes = notes;
        
        if (this.state.ui.searchQuery) {
          const query = this.state.ui.searchQuery.toLowerCase();
          filteredNotes = notes.filter(note => 
            note.title.toLowerCase().includes(query) ||
            note.markdown.toLowerCase().includes(query) ||
            note.tags.some(tag => tag.toLowerCase().includes(query))
          );
        }
        
        if (this.state.ui.activeFilter === 'folders') {
          filteredNotes = filteredNotes.filter(note => note.folderId);
        } else if (this.state.ui.activeFilter === 'pinned') {
          filteredNotes = filteredNotes.filter(note => note.pinned);
        } else if (this.state.ui.activeFilter === 'today') {
          const today = new Date().toDateString();
          filteredNotes = filteredNotes.filter(note => 
            new Date(note.updatedAt).toDateString() === today
          );
        }
        
        // Group notes by folder
        const rootNotes = filteredNotes.filter(note => !note.folderId);
        const folderNotes = new Map();
        
        filteredNotes.filter(note => note.folderId).forEach(note => {
          if (!folderNotes.has(note.folderId)) {
            folderNotes.set(note.folderId, []);
          }
          folderNotes.get(note.folderId).push(note);
        });
        
        // Sort notes
        const sortNotes = (notesList) => {
          return notesList.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return new Date(b.updatedAt) - new Date(a.updatedAt);
          });
        };
        
        let html = '';
        
        // Render folders with their notes
        folders.forEach(folder => {
          const folderNotesArray = folderNotes.get(folder.id) || [];
          if (folderNotesArray.length === 0 && this.state.ui.searchQuery) return;
          
          const isExpanded = this.state.ui.expandedFolders.has(folder.id);
          const sortedFolderNotes = sortNotes(folderNotesArray);
          
          html += `
            <div class="folder-item ${isExpanded ? 'expanded' : ''}" data-folder-id="${folder.id}">
              <div class="folder-header">
                <span class="folder-toggle">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                <span>üìÅ ${this.escapeHtml(folder.name)} (${sortedFolderNotes.length})</span>
                <button class="btn ghost small" onclick="app.deleteFolder('${folder.id}')" style="margin-left: auto;">üóëÔ∏è</button>
              </div>
              ${isExpanded ? `
                <div class="folder-notes">
                  ${sortedFolderNotes.map(note => this.renderNoteItem(note)).join('')}
                </div>
              ` : ''}
            </div>
          `;
        });
        
        // Render root notes
        const sortedRootNotes = sortNotes(rootNotes);
        html += sortedRootNotes.map(note => this.renderNoteItem(note)).join('');
        
        noteList.innerHTML = html;
      }

      renderNoteItem(note) {
        const isActive = note.id === this.state.activeNoteId;
        
        return `
          <div class="note-item ${isActive ? 'active' : ''}" data-note-id="${note.id}">
            <div class="note-title">${this.escapeHtml(note.title)}</div>
            <div class="note-meta">
              <div class="note-dates">
                <span>Modified: ${this.formatDate(note.updatedAt)}</span>
                <span>Created: ${this.formatDate(note.createdAt)}</span>
              </div>
              <div class="flex items-center gap-1">
                ${note.pinned ? '<span>üìå</span>' : ''}
                <button class="btn ghost small" onclick="app.showFolderModal('${note.id}')" title="Move to folder">üìÅ</button>
                <button class="btn ghost small" onclick="app.deleteNote('${note.id}')" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }

      updateSaveStatus(status) {
        const dot = document.getElementById('saveStatusDot');
        const text = document.getElementById('saveStatusText');
        
        if (status === 'saved') {
          dot.className = 'status-dot';
          text.textContent = 'Saved';
        } else if (status === 'saving') {
          dot.className = 'status-dot unsaved';
          text.textContent = 'Saving...';
        } else if (status === 'error') {
          dot.className = 'status-dot unsaved';
          text.textContent = 'Save Error';
        } else {
          dot.className = 'status-dot unsaved';
          text.textContent = 'Unsaved';
        }
      }

      updateWordCount() {
        const text = document.getElementById('markdownEditor').value;
        const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
        document.getElementById('wordCount').textContent = `${words} word${words !== 1 ? 's' : ''}`;
      }

      updateTags() {
        if (!this.state.activeNoteId) return;
        
        const note = this.state.notes.get(this.state.activeNoteId);
        if (!note) return;
        
        const markdown = document.getElementById('markdownEditor').value;
        const tags = this.extractTags(markdown);
        
        note.tags = tags;
        document.getElementById('tagsDisplay').textContent = 
          tags.length > 0 ? tags.map(tag => `#${tag}`).join(' ') : '';
      }

      updateCounts() {
        const totalNotes = this.state.notes.size;
        document.getElementById('noteCount').textContent = 
          `${totalNotes} note${totalNotes !== 1 ? 's' : ''}`;
      }

      // Event Listeners
      setupEventListeners() {
        // Header buttons
        document.getElementById('toggleSidebarBtn').onclick = () => this.toggleSidebar();
        document.getElementById('newNoteBtn').onclick = () => this.createNote();
        document.getElementById('newNoteBtn2').onclick = () => this.createNote();
        document.getElementById('newFolderBtn').onclick = () => this.showCreateFolderDialog();
        document.getElementById('deleteNoteBtn').onclick = () => this.deleteNote(this.state.activeNoteId);
        document.getElementById('settingsBtn').onclick = () => this.showSettings();
        document.getElementById('themeToggleBtn').onclick = () => this.toggleTheme();
        document.getElementById('pinNoteBtn').onclick = () => this.togglePin();

        // Search
        document.getElementById('searchInput').oninput = (e) => {
          this.state.ui.searchQuery = e.target.value;
          this.render();
        };

        // Filter tags
        document.querySelectorAll('.filter-tag').forEach(tag => {
          tag.onclick = () => {
            document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
            tag.classList.add('active');
            this.state.ui.activeFilter = tag.dataset.filter;
            this.render();
          };
        });

        // Editor inputs
        document.getElementById('titleInput').oninput = (e) => {
          this.updateNote({ title: e.target.value || 'Untitled' });
        };

        document.getElementById('markdownEditor').oninput = () => {
          this.syncEditors('markdown');
        };

        document.getElementById('wysiwygEditor').oninput = () => {
          this.syncEditors('wysiwyg');
        };

        // Prevent paste of images in WYSIWYG editor
        document.getElementById('wysiwygEditor').onpaste = (e) => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData('text/plain');
          document.execCommand('insertText', false, text);
          this.syncEditors('wysiwyg');
        };

        // Note list clicks
        document.getElementById('noteList').onclick = (e) => {
          const noteItem = e.target.closest('.note-item');
          const folderItem = e.target.closest('.folder-item');
          const folderToggle = e.target.closest('.folder-toggle');
          
          if (folderToggle && folderItem) {
            e.stopPropagation();
            this.toggleFolder(folderItem.dataset.folderId);
          } else if (noteItem) {
            this.loadNote(noteItem.dataset.noteId);
          }
        };

        // Toolbar commands
        document.querySelectorAll('[data-cmd]').forEach(btn => {
          btn.onclick = () => {
            const cmd = btn.dataset.cmd;
            const value = btn.dataset.value;
            this.execCommand(cmd, value);
          };
        });

        // Special toolbar buttons
        document.getElementById('checkboxBtn').onclick = () => this.insertCheckbox();
        
        document.getElementById('colorBtn').onclick = () => {
          document.getElementById('colorPicker').click();
        };

        document.getElementById('colorPicker').onchange = (e) => {
          this.execCommand('foreColor', e.target.value);
        };

        document.getElementById('linkBtn').onclick = () => {
          const url = prompt('Enter URL:');
          if (url) this.execCommand('createLink', url);
        };

        document.getElementById('codeBtn').onclick = () => {
          document.execCommand('insertHTML', false, '<code>' + document.getSelection() + '</code>');
          this.syncEditors('wysiwyg');
        };

        document.getElementById('quoteBtn').onclick = () => {
          this.execCommand('formatBlock', 'blockquote');
        };

        document.getElementById('toggleMdBtn').onclick = () => this.toggleMarkdownEditor();
        document.getElementById('hideMdBtn').onclick = () => this.hideMarkdownEditor();
        document.getElementById('focusModeBtn').onclick = () => this.toggleFocusMode();

        // Settings modal
        document.getElementById('closeSettingsBtn').onclick = () => this.hideSettings();
        
        // Folder modal
        document.getElementById('closeFolderModalBtn').onclick = () => this.hideFolderModal();
        document.getElementById('cancelFolderBtn').onclick = () => this.hideFolderModal();
        document.getElementById('moveTolderBtn').onclick = () => this.moveNoteToSelectedFolder();
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            this.saveData();
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            this.createNote();
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            this.execCommand('bold');
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
            e.preventDefault();
            this.execCommand('italic');
          }
          if (e.key === 'Escape') {
            this.hideSettings();
            this.hideFolderModal();
          }
        });
      }

      // UI Actions
      toggleSidebar() {
        this.state.ui.sidebarVisible = !this.state.ui.sidebarVisible;
        document.getElementById('app').classList.toggle('sidebar-hidden', !this.state.ui.sidebarVisible);
      }

      toggleTheme() {
        const newTheme = this.state.settings.theme === 'dark' ? 'light' : 'dark';
        this.state.settings.theme = newTheme;
        localStorage.setItem('notes-theme', newTheme);
        this.applyTheme();
      }

      applyTheme() {
        document.getElementById('app').setAttribute('data-theme', this.state.settings.theme);
        const themeBtn = document.getElementById('themeToggleBtn');
        themeBtn.textContent = this.state.settings.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }

      togglePin() {
        if (!this.state.activeNoteId) return;
        
        const note = this.state.notes.get(this.state.activeNoteId);
        note.pinned = !note.pinned;
        this.updateNote(note);
      }

              toggleFolder(folderId) {
        if (this.state.ui.expandedFolders.has(folderId)) {
          this.state.ui.expandedFolders.delete(folderId);
        } else {
          this.state.ui.expandedFolders.add(folderId);
        }
        this.render();
      }

      toggleMarkdownEditor() {
        this.state.settings.mdEditorVisible = !this.state.settings.mdEditorVisible;
        localStorage.setItem('notes-md-visible', this.state.settings.mdEditorVisible);
        
        const container = document.getElementById('editorContainer');
        const btn = document.getElementById('toggleMdBtn');
        
        if (this.state.settings.mdEditorVisible) {
          container.classList.remove('md-hidden');
          container.style.setProperty('--md-editor-width', this.state.settings.mdEditorWidth + 'px');
          container.style.setProperty('--md-divider-width', '1px');
          btn.textContent = 'Hide MD';
        } else {
          container.classList.add('md-hidden');
          btn.textContent = 'Show MD';
        }
      }

      hideMarkdownEditor() {
        this.state.settings.mdEditorVisible = false;
        localStorage.setItem('notes-md-visible', 'false');
        
        const container = document.getElementById('editorContainer');
        const btn = document.getElementById('toggleMdBtn');
        
        container.classList.add('md-hidden');
        btn.textContent = 'Show MD';
      }

      toggleFocusMode() {
        this.state.ui.focusMode = !this.state.ui.focusMode;
        const sidebar = document.querySelector('.sidebar');
        const btn = document.getElementById('focusModeBtn');
        
        if (this.state.ui.focusMode) {
          sidebar.style.display = 'none';
          btn.textContent = 'Exit Focus';
        } else {
          sidebar.style.display = 'flex';
          btn.textContent = 'Focus Mode';
        }
      }

      showCreateFolderDialog() {
        const name = prompt('Folder name:');
        if (name && name.trim()) {
          this.createFolder(name.trim());
        }
      }

      showFolderModal(noteId) {
        const note = this.state.notes.get(noteId);
        if (!note) return;
        
        this.currentNoteToMove = noteId;
        
        // Populate folder options
        const select = document.getElementById('folderSelect');
        select.innerHTML = '<option value="">No folder (Root)</option>';
        
        for (const folder of this.state.folders.values()) {
          const option = document.createElement('option');
          option.value = folder.id;
          option.textContent = folder.name;
          option.selected = note.folderId === folder.id;
          select.appendChild(option);
        }
        
        document.getElementById('folderModal').classList.add('show');
      }

      hideFolderModal() {
        document.getElementById('folderModal').classList.remove('show');
        this.currentNoteToMove = null;
      }

      moveNoteToSelectedFolder() {
        if (!this.currentNoteToMove) return;
        
        const folderId = document.getElementById('folderSelect').value || null;
        this.moveNoteToFolder(this.currentNoteToMove, folderId);
        this.hideFolderModal();
      }

      showSettings() {
        document.getElementById('settingsModal').classList.add('show');
        
        // Populate current settings
        document.getElementById('enableSyncCheck').checked = this.state.settings.syncEnabled;
        document.getElementById('githubTokenInput').value = this.state.settings.githubToken;
        document.getElementById('gistIdInput').value = this.state.settings.gistId;
        
        // Setup settings event listeners
        this.setupSettingsListeners();
      }

      setupSettingsListeners() {
        // Theme buttons
        document.getElementById('darkThemeBtn').onclick = () => {
          this.state.settings.theme = 'dark';
          localStorage.setItem('notes-theme', 'dark');
          this.applyTheme();
        };
        
        document.getElementById('lightThemeBtn').onclick = () => {
          this.state.settings.theme = 'light';
          localStorage.setItem('notes-theme', 'light');
          this.applyTheme();
        };

        // Sync settings
        document.getElementById('enableSyncCheck').onchange = (e) => {
          this.state.settings.syncEnabled = e.target.checked;
          localStorage.setItem('notes-sync-enabled', e.target.checked);
        };

        document.getElementById('githubTokenInput').onchange = (e) => {
          this.state.settings.githubToken = e.target.value;
          localStorage.setItem('notes-github-token', e.target.value);
        };

        document.getElementById('gistIdInput').onchange = (e) => {
          this.state.settings.gistId = e.target.value;
          localStorage.setItem('notes-gist-id', e.target.value);
        };

        // Export/Import
        document.getElementById('exportBtn').onclick = () => this.exportNotes();
        document.getElementById('importBtn').onclick = () => {
          document.getElementById('importFileInput').click();
        };

        document.getElementById('importFileInput').onchange = (e) => {
          if (e.target.files[0]) {
            this.importNotes(e.target.files[0]);
            e.target.value = '';
          }
        };

        // Password change
        document.getElementById('changePasswordBtn').onclick = async () => {
          const newPassword = document.getElementById('newPasswordInput').value;
          if (newPassword) {
            const hash = await this.hashPassword(newPassword);
            localStorage.setItem('notes-password-hash', hash);
            document.getElementById('newPasswordInput').value = '';
            this.showToast('Password updated successfully');
          }
        };

        // Data management
        document.getElementById('clearSyncDataBtn').onclick = () => {
          if (confirm('Clear all sync data and reset sync status? This will not delete your notes.')) {
            localStorage.removeItem('notes-gist-id');
            this.state.settings.gistId = '';
            this.updateSyncStatus('offline');
            this.showToast('Sync data cleared');
          }
        };

        document.getElementById('resetAppBtn').onclick = () => {
          if (confirm('Reset the entire app? This will delete ALL notes and settings. This action cannot be undone.')) {
            localStorage.clear();
            location.reload();
          }
        };
      }

      hideSettings() {
        document.getElementById('settingsModal').classList.remove('show');
      }

      // Export/Import functionality
      async exportNotes() {
        const zip = new JSZip();
        const notesFolder = zip.folder('notes');
        const foldersFolder = zip.folder('folders');
        
        // Add metadata
        const metadata = {
          exportedAt: new Date().toISOString(),
          version: 3,
          totalNotes: this.state.notes.size,
          totalFolders: this.state.folders.size
        };
        zip.file('metadata.json', JSON.stringify(metadata, null, 2));
        
        // Add folders
        for (const [id, folder] of this.state.folders) {
          const filename = this.sanitizeFilename(folder.name) + '.json';
          foldersFolder.file(filename, JSON.stringify(folder, null, 2));
        }
        
        // Add notes
        for (const [id, note] of this.state.notes) {
          const folderName = note.folderId ? 
            this.sanitizeFilename(this.state.folders.get(note.folderId)?.name || 'Unknown') : 
            'root';
          const noteFolder = notesFolder.folder(folderName);
          const filename = this.sanitizeFilename(note.title) + '.md';
          noteFolder.file(filename, note.markdown || '');
        }
        
        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `notes-export-${new Date().toISOString().split('T')[0]}.zip`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showToast('Notes exported successfully');
      }

      async importNotes(file) {
        try {
          const zip = await JSZip.loadAsync(file);
          let importedCount = 0;
          
          // Import folders first
          for (const [path, zipEntry] of Object.entries(zip.files)) {
            if (path.startsWith('folders/') && path.endsWith('.json')) {
              const content = await zipEntry.async('string');
              const folderData = JSON.parse(content);
              
              const folder = {
                id: this.generateId(),
                name: folderData.name || 'Imported Folder',
                createdAt: folderData.createdAt || new Date().toISOString()
              };
              
              this.state.folders.set(folder.id, folder);
            }
          }
          
          // Import notes
          for (const [path, zipEntry] of Object.entries(zip.files)) {
            if (path.startsWith('notes/') && path.endsWith('.md')) {
              const content = await zipEntry.async('string');
              const pathParts = path.split('/');
              const folderName = pathParts[1];
              const filename = pathParts[2].replace('.md', '');
              
              // Find or create folder
              let folderId = null;
              if (folderName !== 'root') {
                const folder = Array.from(this.state.folders.values())
                  .find(f => this.sanitizeFilename(f.name) === folderName);
                if (folder) {
                  folderId = folder.id;
                } else {
                  const newFolder = {
                    id: this.generateId(),
                    name: folderName.replace(/_/g, ' '),
                    createdAt: new Date().toISOString()
                  };
                  this.state.folders.set(newFolder.id, newFolder);
                  folderId = newFolder.id;
                }
              }
              
              const note = {
                id: this.generateId(),
                title: filename.replace(/_/g, ' '),
                content: marked.parse(content),
                markdown: content,
                tags: this.extractTags(content),
                pinned: false,
                folderId: folderId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
              };
              
              this.state.notes.set(note.id, note);
              importedCount++;
            }
          }
          
          this.saveData();
          this.render();
          this.showToast(`Imported ${importedCount} notes successfully`);
          this.hideSettings();
        } catch (error) {
          console.error('Import failed:', error);
          this.showToast('Import failed. Please check the file format.', 'error');
        }
      }

      // Resizer functionality
      setupResizer() {
        const resizer = document.getElementById('mdResizer');
        const container = document.getElementById('editorContainer');
        let isResizing = false;
        let startX = 0;
        let startWidth = this.state.settings.mdEditorWidth;

        resizer.onmousedown = (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = this.state.settings.mdEditorWidth;
          resizer.classList.add('resizing');
          document.body.style.cursor = 'col-resize';
          e.preventDefault();
        };

        document.onmousemove = (e) => {
          if (!isResizing) return;
          
          const deltaX = startX - e.clientX; // Reverse direction
          const newWidth = Math.min(Math.max(startWidth + deltaX, 200), 600);
          
          this.state.settings.mdEditorWidth = newWidth;
          localStorage.setItem('notes-md-width', newWidth);
          
          container.style.setProperty('--md-editor-width', newWidth + 'px');
        };

        document.onmouseup = () => {
          if (!isResizing) return;
          isResizing = false;
          resizer.classList.remove('resizing');
          document.body.style.cursor = '';
        };

        // Apply initial width if MD editor is visible
        if (this.state.settings.mdEditorVisible) {
          container.style.setProperty('--md-editor-width', this.state.settings.mdEditorWidth + 'px');
          container.style.setProperty('--md-divider-width', '1px');
          container.classList.remove('md-hidden');
          document.getElementById('toggleMdBtn').textContent = 'Hide MD';
        }
      }

      // Auto-save functionality
      startAutoSave() {
        setInterval(() => {
          if (this.state.settings.autoSave) {
            this.saveData();
          }
        }, 30000); // Auto-save every 30 seconds
      }

      debounceSave() {
        clearTimeout(this.debounceTimeouts.get('save'));
        this.debounceTimeouts.set('save', setTimeout(() => {
          this.saveData();
        }, 1000));
      }

      // Utility functions
      generateId() {
        return 'note_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
      }

      escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      sanitizeFilename(name) {
        return name.replace(/[^a-z0-9]/gi, '_').toLowerCase().substring(0, 50);
      }

      formatDate(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffInMs = now - date;
        const diffInMinutes = Math.floor(diffInMs / 60000);
        const diffInHours = Math.floor(diffInMs / 3600000);
        const diffInDays = Math.floor(diffInMs / 86400000);

        if (diffInMinutes < 1) return 'Just now';
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        if (diffInHours < 24) return `${diffInHours}h ago`;
        if (diffInDays < 7) return `${diffInDays}d ago`;
        return date.toLocaleDateString();
      }

      extractTags(text) {
        const tagRegex = /#([a-zA-Z0-9_-]+)/g;
        const matches = text.match(tagRegex) || [];
        return [...new Set(matches.map(tag => tag.substring(1)))];
      }

      showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--panel);
          border: 1px solid var(--border);
          border-radius: 12px;
          padding: 16px 20px;
          box-shadow: var(--shadow-lg);
          z-index: 1000;
          font-size: 14px;
          font-weight: 500;
          color: ${type === 'error' ? 'var(--danger)' : 'var(--text)'};
          transform: translateX(100%);
          transition: transform 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.transform = 'translateX(0)';
        }, 10);

        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }

      // Cloud sync functionality (GitHub Gist)
      async syncToGist() {
        if (!this.state.settings.syncEnabled || !this.state.settings.githubToken) {
          return false;
        }

        try {
          const syncData = {
            notes: Array.from(this.state.notes.values()).map(note => ({
              ...note,
              // Remove any problematic content before syncing
              content: this.sanitizeHtmlContent(note.content || ''),
              markdown: note.markdown || ''
            })),
            folders: Array.from(this.state.folders.values()),
            syncedAt: new Date().toISOString(),
            version: 3
          };

          const gistData = {
            description: 'Personal Notes App Data',
            public: false,
            files: {
              'notes-data.json': {
                content: JSON.stringify(syncData, null, 2)
              }
            }
          };

          let url = 'https://api.github.com/gists';
          let method = 'POST';

          if (this.state.settings.gistId) {
            url = `https://api.github.com/gists/${this.state.settings.gistId}`;
            method = 'PATCH';
          }

          const response = await fetch(url, {
            method,
            headers: {
              'Authorization': `token ${this.state.settings.githubToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(gistData)
          });

          if (response.ok) {
            const result = await response.json();
            if (!this.state.settings.gistId) {
              this.state.settings.gistId = result.id;
              localStorage.setItem('notes-gist-id', result.id);
            }
            return true;
          } else {
            console.error(`Sync failed: ${response.status}`, await response.text());
            return false;
          }
        } catch (error) {
          console.error('Sync error:', error);
          return false;
        }
      }

      async syncFromGist() {
        if (!this.state.settings.syncEnabled || !this.state.settings.githubToken || !this.state.settings.gistId) {
          return false;
        }

        try {
          const response = await fetch(`https://api.github.com/gists/${this.state.settings.gistId}`, {
            headers: {
              'Authorization': `token ${this.state.settings.githubToken}`
            }
          });

          if (response.ok) {
            const gist = await response.json();
            const content = gist.files['notes-data.json']?.content;
            
            if (content) {
              const syncData = JSON.parse(content);
              
              // Merge data
              this.state.notes = new Map(syncData.notes?.map(note => [note.id, {
                ...note,
                // Ensure content is sanitized
                content: this.sanitizeHtmlContent(note.content || '')
              }]) || []);
              this.state.folders = new Map(syncData.folders?.map(folder => [folder.id, folder]) || []);
              
              this.saveData();
              this.render();
              this.showToast('Notes synced from cloud');
              return true;
            }
          } else {
            console.error(`Sync from gist failed: ${response.status}`);
          }
        } catch (error) {
          console.error('Sync from gist error:', error);
        }
        return false;
      }

      updateSyncStatus(status) {
        const syncStatus = document.getElementById('syncStatus');
        syncStatus.className = `sync-status ${status}`;
        
        const statusText = {
          'offline': 'Offline',
          'syncing': 'Syncing...',
          'synced': 'Synced',
          'error': 'Sync Error'
        };
        
        syncStatus.textContent = statusText[status] || status;
      }

      // .env loader
      async loadEnv() {
        this.env = {};
        try {
          let res = await fetch('/env.json', { cache: 'no-store' });
          if (res.ok) {
            const json = await res.json();
            this.env = json || {};
          } else {
            res = await fetch('/.env', { cache: 'no-store' });
            if (res.ok) {
              const text = await res.text();
              this.env = this.parseEnv(text);
            }
          }

          if (this.env.GITHUB_TOKEN) this.state.settings.githubToken = this.env.GITHUB_TOKEN;
          if (this.env.GIST_ID) this.state.settings.gistId = this.env.GIST_ID;
          if (this.env.GITHUB_TOKEN && this.env.GIST_ID) this.state.settings.syncEnabled = true;
        } catch (e) {
          // No env is fine
        }
      }

      parseEnv(text) {
        const env = {};
        text.split('\n').forEach(line => {
          const trimmed = line.trim();
          if (!trimmed || trimmed.startsWith('#')) return;
          const idx = trimmed.indexOf('=');
          if (idx === -1) return;
          const key = trimmed.substring(0, idx).trim();
          let value = trimmed.substring(idx + 1).trim();
          if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith('\'') && value.endsWith('\''))) {
            value = value.substring(1, value.length - 1);
          }
          env[key] = value;
        });
        return env;
      }
    }

    // Initialize the app
    let app;
    document.addEventListener('DOMContentLoaded', () => {
      app = new NotesApp();
    });

    // Service Worker for offline functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swCode = `
          const CACHE_NAME = 'personal-notes-v2';
          const urlsToCache = [
            '${location.href}',
            'https://cdn.jsdelivr.net/npm/marked/marked.min.js',
            'https://cdn.jsdelivr.net/npm/turndown@7.1.3/dist/turndown.min.js',
            'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js'
          ];

          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
                .then(() => self.skipWaiting())
            );
          });

          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => response || fetch(event.request))
            );
          });
        `;

        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('ServiceWorker registered');
          })
          .catch(error => {
            console.log('ServiceWorker registration failed');
          });
      });
    }
  </script>
</body>
</html>
